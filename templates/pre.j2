#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR={{backup.work}}/{{item.name}}

{% if item.source.startswith('postgresql://') %}

DBNAME={{item.source.split('postgresql://')[-1]}}
PGPASSWORD="{{item.postgres_pass}}" pg_dump -U {{item.postgres_user|default(postgres.postgres_user)}} -h {{item.postgres_host}} -p {{item.postgres_port}} -c $DBNAME -f ${WORKDIR}/dump

{% elif item.source.startswith('mysql://') %}

{% if item.source == 'mysql://' %}
# Dump all databases
mysqldump -u {{item.mysql_user|default(mysql.mysql_user)}} -p{{item.mysql_pass|default(mysql.mysql_pass)}} --all-databases > ${WORKDIR}/dump
{% else %}

# Dump the passed database
DBNAME={{item.source.split('mysql://')[-1]}}
mysqldump -u {{item.mysql_user|default(mysql.mysql_user)}} -p{{item.mysql_pass|default(mysql.mysql_pass)}} {{ '-h ' + item.mysql_host if item.mysql_host else ''}} {{ ('-P ' % item.mysql_port) if item.mysql_port else ''}} $DBNAME  > ${WORKDIR}/dump
{% endif %}

{% elif item.source.startswith('mongo://') %}

mongodump --out $WORKDIR/dump

{% endif %}

{% for action in item.pre_actions|default([]) %}
{{ action }}
{% endfor %}
